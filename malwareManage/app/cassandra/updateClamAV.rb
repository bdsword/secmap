require 'cassandra'

def updateClamAV(client,taskID)
	rep=client.get(:CLAMAV, taskID)["OVERALL"]
	if rep == nil
		p "nil"
		return 
	end
	rep = rep.split("\n")[0]
	if rep == nil
		#client.insert(:CLAMAV, taskID, {"OVERALL"=> ""})
		return
	end
	p rep
	rep.gsub!(" FOUND","")
	start = rep.index(":")
	if start==nil
		return
	end
	p rep[start+2..-1]
	client.insert(:CLAMAV, taskID, {"OVERALL"=> rep[start+2..-1]})
end


client = Cassandra.new('SECMAP',"192.168.100.107:9160")
count = 100
list = client.get_range_keys(:SUMMARY, :key_count => 100)
first = list[0]
last = nil
list.each do |sample|
	puts sample
	last = sample
	updateClamAV(client,sample)
end

while true do
	#break
	begin
		list = client.get_range_keys(:SUMMARY, :key_count => 100, :start_key=>last)
	rescue
		next
	end
	flag = false
	list.each do |sample|
		puts sample
		updateClamAV(client,sample)
		last = sample
		if sample == first
			flag = true
		end
	end
	if flag
		break
	end
	if list.size < 100
		break
	end
	count += 100
	p count
end
